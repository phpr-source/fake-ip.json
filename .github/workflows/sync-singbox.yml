name: Force Build sing-box (reF1nd)

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 必须有写权限
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: main
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Prepare Settings
        run: |
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          # 生成带时间戳的版本号，防止重复
          VERSION="reF1nd-$(date +%Y%m%d%H%M)-${COMMIT_SHORT}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "BUILD_TAGS=with_gvisor,with_quic,with_utls,with_acme,with_clash_api" >> $GITHUB_ENV

      - name: Build AMD64
        run: |
          echo "正在编译 AMD64..."
          go build -trimpath -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
          -tags "${BUILD_TAGS}" \
          -o sing-box-amd64 \
          ./cmd/sing-box
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0

      - name: Build ARM64
        run: |
          echo "正在编译 ARM64..."
          go build -trimpath -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
          -tags "${BUILD_TAGS}" \
          -o sing-box-arm64 \
          ./cmd/sing-box
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0

      # 新增步骤：检查文件是否存在，方便排错
      - name: List Files (Debug)
        run: |
          ls -lh sing-box-amd64 sing-box-arm64

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          # 使用动态标签，保证每次都是新发布
          tag_name: lite-${{ env.VERSION }}
          name: Sing-box Lite (${{ env.VERSION }})
          body: |
            手动强制编译版本
            Version: ${{ env.VERSION }}
            Tags: ${{ env.BUILD_TAGS }}
          files: |
            sing-box-amd64
            sing-box-arm64
          # 如果文件不存在，强制报错
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
