name: Force Build sing-box (reF1nd)

on:
  workflow_dispatch: # 只能手动触发，保证必须执行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 核心：必须有写权限才能上传 Release
    
    steps:
      # 1. 准备环境
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: main
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      # 2. 准备版本号和编译标签 (保留了你的 Lite 需求)
      - name: Prepare Settings
        run: |
          # 获取短 Commit SHA
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          # 生成版本号
          VERSION="reF1nd-$(date +%Y%m%d)-${COMMIT_SHORT}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          # 设定编译参数 (包含 gvisor, utls, clash_api 等)
          echo "BUILD_TAGS=with_gvisor,with_quic,with_utls,with_acme,with_clash_api" >> $GITHUB_ENV

      # 3. 强制编译 AMD64
      - name: Build AMD64
        run: |
          echo "正在编译 AMD64..."
          go build -trimpath -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
          -tags "${BUILD_TAGS}" \
          -o sing-box-amd64 \
          ./cmd/sing-box
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0

      # 4. 强制编译 ARM64
      - name: Build ARM64
        run: |
          echo "正在编译 ARM64..."
          go build -trimpath -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
          -tags "${BUILD_TAGS}" \
          -o sing-box-arm64 \
          ./cmd/sing-box
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0

      # 5. 强制上传 (关键步骤)
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: singbox  # 固定标签
          name: Sing-box Lite Force Build
          body: |
            这是强制编译版本。
            Source: reF1nd/sing-box
            Version: ${{ env.VERSION }}
            Tags: ${{ env.BUILD_TAGS }}
          files: |
            sing-box-amd64
            sing-box-arm64
          make_latest: true
