name: Smart Build sing-box (reF1nd)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */4 * * *' # æ¯ 4 å°æ—¶æ£€æŸ¥ä¸€æ¬¡ (UTCæ—¶é—´)

jobs:
  # ä»»åŠ¡ 1: æ£€æŸ¥ç‰ˆæœ¬
  check:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.compare.outputs.status }}
      upstream_sha: ${{ steps.upstream.outputs.short_sha }}
    steps:
      - name: Get Upstream SHA (reF1nd)
        id: upstream
        run: |
          # è·å– reF1nd ä»“åº“ main åˆ†æ”¯æœ€æ–°çš„ Commit SHA
          SHA=$(git ls-remote https://github.com/reF1nd/sing-box.git refs/heads/main | awk '{ print $1 }')
          SHORT_SHA=${SHA:0:7}
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Upstream Latest: $SHORT_SHA"

      - name: Get Local Release SHA
        id: local
        run: |
          # è·å–ä½ è‡ªå·±ä»“åº“ 'singbox' æ ‡ç­¾çš„ Release è¯´æ˜
          # æˆ‘ä»¬ä¼šåœ¨ Release è¯´æ˜é‡Œå†™å…¥ "Commit: xxxxxxx"
          BODY=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/singbox | jq -r '.body' || echo "")
          
          # æå– Commit å€¼
          LOCAL_SHA=$(echo "$BODY" | grep -oP 'Commit: \K\w+' || echo "none")
          echo "local_sha=$LOCAL_SHA" >> $GITHUB_OUTPUT
          echo "Local Last Build: $LOCAL_SHA"

      - name: Compare Versions
        id: compare
        run: |
          UPSTREAM="${{ steps.upstream.outputs.short_sha }}"
          LOCAL="${{ steps.local.outputs.local_sha }}"
          
          # åˆ¤æ–­é€»è¾‘ï¼š
          # 1. å¦‚æœæ‰‹åŠ¨è§¦å‘ (workflow_dispatch)ï¼Œå¼ºåˆ¶æ›´æ–°
          # 2. å¦‚æœæœ¬åœ°æ˜¯ none (ç¬¬ä¸€æ¬¡è¿è¡Œ)ï¼Œå¼ºåˆ¶æ›´æ–°
          # 3. å¦‚æœ SHA ä¸ä¸€æ ·ï¼Œæ›´æ–°
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "status=build" >> $GITHUB_OUTPUT
            echo "è§¦å‘ç±»å‹: æ‰‹åŠ¨è§¦å‘ -> å‡†å¤‡ç¼–è¯‘"
          elif [ "$LOCAL" == "none" ]; then
            echo "status=build" >> $GITHUB_OUTPUT
            echo "è§¦å‘ç±»å‹: é¦–æ¬¡è¿è¡Œ/æ— æ³•è¯»å–æ—§ç‰ˆæœ¬ -> å‡†å¤‡ç¼–è¯‘"
          elif [ "$UPSTREAM" != "$LOCAL" ]; then
            echo "status=build" >> $GITHUB_OUTPUT
            echo "è§¦å‘ç±»å‹: å‘ç°æ–°ç‰ˆæœ¬ ($UPSTREAM vs $LOCAL) -> å‡†å¤‡ç¼–è¯‘"
          else
            echo "status=skip" >> $GITHUB_OUTPUT
            echo "è§¦å‘ç±»å‹: ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°"
          fi

  # ä»»åŠ¡ 2: ç¼–è¯‘ä¸å‘å¸ƒ (åªæœ‰ check è¿”å› build æ—¶æ‰è¿è¡Œ)
  build:
    needs: check
    if: needs.check.outputs.status == 'build'
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰å†™æƒé™
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: main
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Prepare Settings
        run: |
          # ç”Ÿæˆç‰ˆæœ¬å· (æ ¼å¼: reF1nd-æ—¥æœŸ-Hash)
          VERSION="reF1nd-$(date +%Y%m%d)-${{ needs.check.outputs.upstream_sha }}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          
          # ä½ çš„ Lite ç¼–è¯‘å‚æ•°
          echo "BUILD_TAGS=with_gvisor,with_quic,with_utls,with_acme,with_clash_api" >> $GITHUB_ENV

      - name: Build AMD64
        run: |
          echo "Building AMD64..."
          go build -trimpath -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
          -tags "${BUILD_TAGS}" \
          -o sing-box-amd64 \
          ./cmd/sing-box
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0

      - name: Build ARM64
        run: |
          echo "Building ARM64..."
          go build -trimpath -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" \
          -tags "${BUILD_TAGS}" \
          -o sing-box-arm64 \
          ./cmd/sing-box
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0

      - name: Verify Files
        run: |
          ls -lh sing-box-amd64 sing-box-arm64

      # å…³é”®æ­¥éª¤ï¼šå…ˆåˆ é™¤æ—§çš„ 'singbox' æ ‡ç­¾ Releaseï¼Œå®ç°â€œæ»šåŠ¨æ›´æ–°â€
      # è¿™æ ·ä½ çš„ä¸‹è½½é“¾æ¥æ°¸è¿œä¸å˜
      - name: Delete Old Release
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: singbox
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload New Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: singbox
          name: Sing-box Lite (Rolling Release)
          # æ³¨æ„ï¼šBody é‡Œå¿…é¡»åŒ…å« 'Commit: xxx'ï¼Œä¾›ä¸‹æ¬¡æ£€æŸ¥ä½¿ç”¨
          body: |
            ## ğŸš€ è‡ªåŠ¨æ„å»º (Lite Core)
            - **æ¥æº**: reF1nd/sing-box
            - **ç‰ˆæœ¬**: ${{ env.VERSION }}
            - **Commit**: ${{ needs.check.outputs.upstream_sha }}
            - **æ›´æ–°æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')
            
            ### åŒ…å«ç‰¹æ€§ (Tags)
            `${{ env.BUILD_TAGS }}`
            
            ### æ¶æ„
            - `amd64`: é€‚ç”¨äº VPS, x86è½¯è·¯ç”±, ç”µè„‘
            - `arm64`: é€‚ç”¨äº æ ‘è“æ´¾, N1ç›’å­, Android, ARM VPS
          files: |
            sing-box-amd64
            sing-box-arm64
          fail_on_unmatched_files: true
          make_latest: true
