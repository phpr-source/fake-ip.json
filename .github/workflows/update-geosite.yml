name: Update Geosite Rule Sets

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. 下載 elysias123 的 geosite.dat (使用 wget 是 OK 的，因為這個連結是固定的)
      - name: Download Geosite Dat
        run: |
          mkdir -p temp
          wget -q -O temp/geosite.dat https://github.com/elysias123/geosite/releases/latest/download/geosite.dat

      # 2. 使用 gh 工具下載 geodat2srs (更穩定，避免 Exit code 8)
      - name: Install geodat2srs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download -R runetfreedom/geodat2srs --pattern "*linux-amd64" --clobber
          # 將下載的檔案重命名並賦予執行權限
          mv geodat2srs-linux-amd64 geodat2srs
          chmod +x geodat2srs

      # 3. 使用 gh 工具下載您自己的 Sing-box Core
      - name: Install Your Sing-box Core
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 從您自己的倉庫 phpr-source/sing-box.json 下載最新 release
          gh release download -R phpr-source/sing-box.json --pattern "*linux-amd64.tar.gz" --clobber
          tar -xvf *.tar.gz
          # 找到核心檔案並統一命名
          find . -type f -name "sing-box" -exec mv {} ./sb-core \;
          chmod +x ./sb-core

      # 4. 拆分並整齊排列
      - name: Split and Convert
        run: |
          # 建立目標目錄 (根據您的截圖，建議放在 rules 之下)
          mkdir -p rules/srs
          mkdir -p rules/json
          
          # 拆分為 SRS (這會把 dat 裡的每個類別拆成獨立的 .srs)
          ./geodat2srs geosite -i temp/geosite.dat -o rules/srs --prefix ""
          
          # 遍歷生成的 srs，使用您的核心轉成 json 並放在另一個資料夾
          echo "Converting to JSON for neat arrangement..."
          for file in rules/srs/*.srs; do
            filename=$(basename "$file" .srs)
            ./sb-core rule-set decompile --output "rules/json/$filename.json" "$file"
          done

      # 5. 提交並推送到您的倉庫
      - name: Commit and Push
        run: |
          rm -rf temp geodat2srs *.tar.gz sb-core
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加生成的規則文件
          git add rules/srs/ rules/json/
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update: Separate Geosite rules $(date +'%Y-%m-%d')"
            git push
          fi
