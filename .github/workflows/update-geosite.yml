name: Update Geosite Rule Sets

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. 設置 Go 編譯環境 (這是解決問題的關鍵)
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 2. 從源碼編譯並安裝 geodat2srs
      - name: Install geodat2srs from source
        run: |
          echo "Installing geodat2srs..."
          go install github.com/runetfreedom/geodat2srs@latest
          
          # 將編譯好的工具複製到當前目錄，方便後面調用
          cp $(go env GOPATH)/bin/geodat2srs .
          chmod +x geodat2srs
          
          echo "geodat2srs installed successfully!"

      # 3. 下載 geosite.dat (這個連結是有效的)
      - name: Download Geosite Dat
        run: |
          mkdir -p temp
          wget -q -O temp/geosite.dat https://github.com/elysias123/geosite/releases/latest/download/geosite.dat

      # 4. 安裝您倉庫自己的 Sing-box Core
      - name: Install Your Sing-box Core
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 使用 gh 下載您倉庫最新的 Linux-amd64 版本
          gh release download -R phpr-source/sing-box.json --pattern "*linux-amd64.tar.gz" --clobber
          
          # 解壓
          tar -xvf *.tar.gz
          
          # 找到核心檔案並統一命名
          find . -type f -name "sing-box" -exec mv {} ./sb-core \;
          chmod +x ./sb-core

      # 5. 拆分並轉換格式
      - name: Split and Convert
        run: |
          # 建立目標目錄
          mkdir -p rules/srs
          mkdir -p rules/json
          
          # 使用剛剛編譯的 geodat2srs 拆分 DAT 文件
          echo "Splitting DAT into SRS..."
          ./geodat2srs geosite -i temp/geosite.dat -o rules/srs --prefix ""
          
          # 使用您的核心將 SRS 轉為 JSON (確保可讀性與版本兼容)
          echo "Converting SRS to JSON..."
          cd rules/srs
          for file in *.srs; do
            filename=$(basename "$file" .srs)
            # 反編譯生成 json
            ../../sb-core rule-set decompile --output "../json/$filename.json" "$file"
          done
          cd ../..

      # 6. 提交並推送到您的倉庫
      - name: Commit and Push
        run: |
          # 清理臨時文件
          rm -rf temp geodat2srs *.tar.gz sb-core
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加生成的規則文件
          git add rules/srs/ rules/json/
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update: Separate Geosite rules $(date +'%Y-%m-%d')"
            git push
          fi
