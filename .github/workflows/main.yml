name: Update Comprehensive SRS

on:
  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹
  push:
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'fakeip-filter-Remote-DNS.json'
      - 'rules.json' # æ–°å¢ï¼šè§„åˆ™åˆ—è¡¨å˜åŠ¨æ—¶è§¦å‘
  # --- æ–°å¢ï¼šæ‰‹åŠ¨è¾“å…¥æ¥å£ ---
  workflow_dispatch:
    inputs:
      manual_name:
        description: 'ä¸´æ—¶ä»»åŠ¡ï¼šæ–‡ä»¶å (ä¸å¸¦åç¼€)'
        required: false
      manual_url:
        description: 'ä¸´æ—¶ä»»åŠ¡ï¼šè§„åˆ™é“¾æ¥'
        required: false

env:
  URL_ADBLOCK: "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json"
  URL_FAKEIP_S1: "https://raw.githubusercontent.com/77160860/rule/refs/heads/main/filter.json"
  URL_FAKEIP_S2_SRS: "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs"
  URL_FAKEIP_S3_LIST: "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list"
  URL_WEBRTC: "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ============================================================
      # 1. å®‰è£… Sing-box (ä½¿ç”¨ä½ è‡ªå·±çš„ Build)
      # ============================================================
      - name: Install My Custom sing-box
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/singbox/sing-box-amd64"
          echo "ä¸‹è½½æ ¸å¿ƒ: $DOWNLOAD_URL"
          curl -L --fail --retry 3 "$DOWNLOAD_URL" -o sing-box
          chmod +x sing-box
          
          SB_VERSION=$(./sing-box version | awk '/version/{print $3}')
          echo "SB_VERSION=$SB_VERSION" >> $GITHUB_ENV

      # ============================================================
      # æ–°å¢ 1: è¿è¡Œæ‰‹åŠ¨ä»»åŠ¡ (å¦‚æœæœ‰è¾“å…¥)
      # ============================================================
      - name: Run Manual Task
        if: ${{ inputs.manual_name != '' && inputs.manual_url != '' }}
        run: |
          # è°ƒç”¨å·¥å‚è„šæœ¬ï¼Œä¼ å…¥å‚æ•°
          python3 scripts/build_factory.py "${{ inputs.manual_name }}" "${{ inputs.manual_url }}"

      # ============================================================
      # æ–°å¢ 2: è¿è¡Œæ‰¹é‡å·¥å‚ (å¤„ç† rules.json ä¸­çš„ç®€å•è§„åˆ™)
      # ============================================================
      - name: Run Batch Factory
        # ä»…åœ¨ä¸æ˜¯æ‰‹åŠ¨ä»»åŠ¡æ—¶ï¼Œæ‰è·‘æ‰¹é‡ï¼ˆæˆ–è€…ä½ å¯ä»¥å»æ‰è¿™ä¸ª ifï¼Œè®©å®ƒæ€»æ˜¯è·‘ï¼‰
        if: ${{ inputs.manual_name == '' }}
        run: python3 scripts/build_factory.py

      # ============================================================
      # 3. Task A: Adblock (ä¿ç•™åŸæ ·ï¼Œä½œä¸ºæ ¸å¿ƒä»»åŠ¡)
      # ============================================================
      - name: Task A - Build Adblock SRS
        run: |
          curl -sL --fail --retry 3 "$URL_ADBLOCK" -o Adblock.json
          ./sing-box rule-set compile Adblock.json -o Adblock.srs

      # ============================================================
      # 4. Task B: FakeIP-Filter (å¤æ‚çš„å…±è¯†é€»è¾‘ï¼Œå¿…é¡»ä¿ç•™ç‹¬ç«‹æ­¥éª¤)
      # ============================================================
      - name: Task B - Consensus Merge
        run: |
          # ä¸‹è½½æºæ–‡ä»¶
          curl -sL --fail --retry 3 "$URL_FAKEIP_S1" -o s1.json
          curl -sL --fail --retry 3 "$URL_FAKEIP_S2_SRS" -o s2.srs
          curl -sL --fail --retry 3 "$URL_FAKEIP_S3_LIST" -o s3.list
          
          ./sing-box rule-set decompile s2.srs -o s2.json
          
          # è¿è¡Œä½ ä¹‹å‰å†™çš„ä¸“ç”¨åˆå¹¶è„šæœ¬
          python3 scripts/merge_fakeip.py
          
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs

      # ============================================================
      # 5. Task C: Manual Remote-DNS
      # ============================================================
      - name: Task C - Compile Manual Remote-DNS
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          else
            echo "Warning: fakeip-filter-Remote-DNS.json not found, skipping."
          fi

      # ============================================================
      # 6. Task D: WebRTC & Push (åŒ…å«ç‰¹æ®Šçš„ JSON å¤„ç†é€»è¾‘)
      # ============================================================
      - name: Task D - Finalize & Push
        run: |
          curl -sL --fail --retry 3 "$URL_WEBRTC" -o raw_webrtc.json
          python3 -c "import json; d=json.load(open('raw_webrtc.json')); open('webRTC.json','w').write(json.dumps({'version': 3, 'rules': d.get('rules', [])}, indent=2))"
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f s1.json s2.json s2.srs s3.list raw_webrtc.json sing-box sing-box.tar.gz temp_*.json
          
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          git add *.json *.srs
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ğŸš€ Sync Rules | Core: ${{ env.SB_VERSION }} | $(date +'%Y-%m-%d')"
            git push origin main
          fi
