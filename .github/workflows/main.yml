name: Update Comprehensive SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - 'fakeip-filter-Remote-DNS.json'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: # æ˜¾å¼å£°æ˜æƒé™ï¼Œç¡®ä¿ Actions æœ‰æƒæ¨é€ä»£ç 
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Latest sing-box
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
          echo "Installing sing-box version $LATEST_VERSION"
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VERSION}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .

      - name: Combine Remote Rules (FakeIP)
        run: |
          # æŠ“å–è¿œç¨‹è§„åˆ™
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o henry.list
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o dustin.srs
          
          # åç¼–è¯‘ Dustin çš„äºŒè¿›åˆ¶æ–‡ä»¶
          ./sing-box rule-set decompile dustin.srs -o dustin.json

          # Python é«˜çº§åˆå¹¶é€»è¾‘
          python3 -c "
          import json

          def clean(d):
              return d.lstrip('+').lstrip('.')

          h_domains, h_suffixes = set(), set()
          # è§£æ Henry åˆ—è¡¨
          with open('henry.list') as f:
              for line in f:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  if line.startswith('+') or line.startswith('.'):
                      h_suffixes.add(clean(line))
                  else:
                      h_domains.add(line)

          # è§£æ Dustin JSON
          with open('dustin.json') as f:
              d_data = json.load(f)
          
          d_domains, d_suffixes = set(), set()
          for rule in d_data.get('rules', []):
              d_domains.update(rule.get('domain', []))
              d_suffixes.update(rule.get('domain_suffix', []))

          # åˆå¹¶ä¸å»é‡ä¼˜åŒ–
          final_suffixes = h_suffixes | d_suffixes
          final_domains = (h_domains | d_domains) - final_suffixes

          combined = {
              'version': 1,
              'rules': [{
                  'domain': sorted(list(final_domains)),
                  'domain_suffix': sorted(list(final_suffixes))
              }]
          }
          with open('fakeip-filter.json', 'w', encoding='utf-8') as f:
              json.dump(combined, f, indent=2, ensure_ascii=False)
          "
          # ç¼–è¯‘æˆæœ€ç»ˆçš„ srs
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs

      - name: Process WebRTC Rules
        run: |
          curl -sL "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json" -o raw_webrtc.json
          python3 -c "
          import json
          try:
              with open('raw_webrtc.json', 'r') as f:
                  data = json.load(f)
              output = { 'version': 3, 'rules': data.get('rules', []) }
              with open('webRTC.json', 'w') as f:
                  json.dump(output, f, indent=2)
          except Exception as e:
              print(f'Error: {e}'); exit(1)
          "
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

      - name: Process Custom Rules
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          fi

      - name: Push to Repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f raw_webrtc.json henry.list dustin.srs dustin.json sing-box sing-box.tar.gz
          
          # å¼ºåˆ¶æ¸…ç†æ—§çš„ã€ä¸å†éœ€è¦çš„è§„åˆ™æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git rm -f custom.srs filter.srs custom_rules.json --ignore-unmatch
          
          # æ·»åŠ ç”Ÿæˆçš„æ‰€æœ‰èµ„äº§
          git add webRTC.json webRTC.srs
          git add fakeip-filter.json fakeip-filter.srs
          git add fakeip-filter-Remote-DNS.json fakeip-filter-Remote-DNS.srs
          
          # æäº¤å¹¶æ¨é€
          # ä½¿ç”¨ || true é˜²æ­¢åœ¨æ²¡æœ‰ä»»ä½•å˜åŒ–æ—¶å¯¼è‡´ä»»åŠ¡æŠ¥é”™å¤±è´¥
          git commit -m "ğŸš€ Sync Rules: $(date +'%Y-%m-%d %H:%M') | WebRTC & FakeIP" || true
          git push origin main --force
