name: Update Comprehensive SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - 'fakeip-filter-Remote-DNS.json'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # èµ‹äºˆå†™æƒé™ä»¥ä¾¿ push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Latest sing-box
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
          echo "Installing sing-box version $LATEST_VERSION"
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VERSION}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .
          chmod +x sing-box

      - name: Combine Remote Rules (FakeIP)
        run: |
          # 1. ä¸‹è½½ Henry çš„åˆ—è¡¨ (æ–‡æœ¬æ ¼å¼)
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o henry.list
          
          # 2. ä¸‹è½½ Dustin çš„è§„åˆ™é›† (SRS) å¹¶åç¼–è¯‘
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o dustin.srs
          ./sing-box rule-set decompile dustin.srs -o dustin.json

          # 3. ä½¿ç”¨ Python ç²¾å‡†åˆå¹¶å¹¶ç”Ÿæˆ fakeip-filter.json
          python3 -c "
          import json
          import re

          # è¯»å– Henry çš„åˆ—è¡¨
          h_domains = []
          h_suffixes = []
          try:
              with open('henry.list', 'r') as f:
                  for line in f:
                      line = line.strip()
                      # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
                      if not line or line.startswith('#'):
                          continue
                      
                      # å¤„ç† Clash/Mihomo æ ¼å¼: '+.google.com' æˆ– '.google.com' è§†ä¸ºåç¼€
                      if line.startswith('+.') or line.startswith('.'):
                          # å»é™¤å¼€å¤´çš„ + å’Œ .
                          clean_suffix = re.sub(r'^[+.]+', '', line)
                          h_suffixes.append(clean_suffix)
                      else:
                          # æ²¡æœ‰å‰ç¼€çš„è§†ä¸ºç²¾ç¡®åŸŸå (è§†å…·ä½“éœ€æ±‚è€Œå®šï¼Œé€šå¸¸ fake-ip åˆ—è¡¨é‡Œå¤šä¸ºåç¼€ï¼Œä½†ç²¾ç¡®åŒ¹é…æ›´å®‰å…¨)
                          h_domains.append(line)
          except Exception as e:
              print(f'Warning reading henry.list: {e}')

          # è¯»å– Dustin çš„ JSON
          d_domains = []
          d_suffixes = []
          try:
              with open('dustin.json', 'r') as f:
                  d_data = json.load(f)
                  # éå†æ‰€æœ‰è§„åˆ™æå–åŸŸå
                  for rule in d_data.get('rules', []):
                      d_domains.extend(rule.get('domain', []))
                      d_suffixes.extend(rule.get('domain_suffix', []))
          except Exception as e:
              print(f'Warning reading dustin.json: {e}')

          # åˆå¹¶å¹¶å»é‡
          final_domains = sorted(list(set(d_domains + h_domains)))
          final_suffixes = sorted(list(set(d_suffixes + h_suffixes)))

          # æ„å»º Sing-box Rule-Set (Version 2)
          combined = {
              'version': 2,
              'rules': [
                  {
                      'domain': final_domains,
                      'domain_suffix': final_suffixes
                  }
              ]
          }

          # å†™å…¥ fakeip-filter.json (ç”¨æˆ·è¦æ±‚ä¿ç•™æ­¤æ–‡ä»¶)
          with open('fakeip-filter.json', 'w') as f:
              json.dump(combined, f, indent=2)
          
          print(f'Merged: {len(final_domains)} domains, {len(final_suffixes)} suffixes.')
          "

          # 4. ç¼–è¯‘ä¸º srs
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs

      - name: Process WebRTC Rules (Remote JSON to Version 3 SRS)
        run: |
          curl -sL "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json" -o raw_webrtc.json
          
          python3 -c "
          import json
          try:
              with open('raw_webrtc.json', 'r') as f:
                  data = json.load(f)
              # ç¡®ä¿è¾“å‡ºæ ¼å¼è§„èŒƒ
              output = {
                  'version': 3,
                  'rules': data.get('rules', [])
              }
              with open('webRTC.json', 'w') as f:
                  json.dump(output, f, indent=2)
              print('Successfully transformed webRTC.json to Version 3')
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "
          
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

      - name: Process Custom Rules
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          fi

      - name: Push to Repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ (æ³¨æ„ï¼šä¿ç•™äº† fakeip-filter.json)
          rm -f raw_webrtc.json henry.list dustin.srs dustin.json sing-box sing-box.tar.gz
          rm -rf sing-box-*
          
          # å¼ºåˆ¶æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add webRTC.json webRTC.srs
          git add fakeip-filter.srs fakeip-filter.json
          git add fakeip-filter-Remote-DNS.srs
          
          # æäº¤æ›´æ”¹
          # å¦‚æœæ²¡æœ‰æ›´æ”¹ï¼Œæäº¤ä¼šå¤±è´¥ï¼Œä½¿ç”¨ || exit 0 å¿½ç•¥é”™è¯¯
          git commit -m "ğŸš€ Sync Rules: $(date +'%Y-%m-%d %H:%M') | WebRTC & FakeIP JSON/SRS" || exit 0
          
          git push origin main --force
