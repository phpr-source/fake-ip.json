name: Update Comprehensive SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - 'fakeip-filter-Remote-DNS.json'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Latest sing-box
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
          echo "Installing sing-box version $LATEST_VERSION"
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VERSION}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .
          chmod +x sing-box

      - name: Advanced Merge Rules (FakeIP)
        run: |
          echo "ğŸ“¥ Downloading Sources..."
          
          # 1. æº A: 77160860 (JSON - ç»“æ„æœ€è§„èŒƒï¼Œä½œä¸ºåŸºå‡†)
          curl -sL "https://raw.githubusercontent.com/77160860/rule/refs/heads/main/filter.json" -o source_base.json
          
          # 2. æº B: Henry (Text List - éœ€è¦æ¸…æ´—)
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o source_henry.list
          
          # 3. æº C: Dustin (SRS - éœ€è¦åç¼–è¯‘)
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o dustin.srs
          ./sing-box rule-set decompile dustin.srs -o source_dustin.json

          echo "ğŸ”„ Running Python Merge Logic..."
          
          python3 -c "
          import json
          import re
          import os

          # å®šä¹‰å››ä¸ªé›†åˆï¼Œåˆ†åˆ«å­˜å‚¨ä¸åŒç±»å‹çš„è§„åˆ™ï¼Œåˆ©ç”¨ set è‡ªåŠ¨å»é‡
          final_domain = set()
          final_suffix = set()
          final_keyword = set()
          final_regex = set()

          def load_json_rules(filename):
              try:
                  if not os.path.exists(filename):
                      return
                  with open(filename, 'r') as f:
                      data = json.load(f)
                      # éå† rules åˆ—è¡¨
                      for rule in data.get('rules', []):
                          if 'domain' in rule:
                              final_domain.update(rule['domain'])
                          if 'domain_suffix' in rule:
                              final_suffix.update(rule['domain_suffix'])
                          if 'domain_keyword' in rule:
                              final_keyword.update(rule['domain_keyword'])
                          if 'domain_regex' in rule:
                              final_regex.update(rule['domain_regex'])
                  print(f'âœ… Loaded JSON: {filename}')
              except Exception as e:
                  print(f'âŒ Error loading {filename}: {e}')

          # 1. åŠ è½½ JSON æº (77160860 å’Œ Dustin)
          load_json_rules('source_base.json')
          load_json_rules('source_dustin.json')

          # 2. åŠ è½½ Henry æ–‡æœ¬æºå¹¶è¿›è¡Œæ™ºèƒ½æ¸…æ´—
          try:
              with open('source_henry.list', 'r') as f:
                  count = 0
                  for line in f:
                      line = line.strip()
                      # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
                      if not line or line.startswith('#'):
                          continue
                      
                      # é€»è¾‘ä¿®æ­£ï¼š
                      # å¦‚æœä»¥ +. æˆ– . å¼€å¤´ -> è§†ä¸º domain_suffix
                      # å¦‚æœæ˜¯çº¯æ–‡æœ¬ -> è§†ä¸º domain (ç²¾ç¡®åŒ¹é…)
                      
                      if line.startswith('+.') or line.startswith('.'):
                          # ç§»é™¤å¼€å¤´çš„ +. æˆ– .
                          clean = re.sub(r'^[+.]+', '', line)
                          final_suffix.add(clean)
                      else:
                          # åªæœ‰çº¯åŸŸåæ‰æ”¾å…¥ domainï¼Œé¿å…è¯¯ä¼¤
                          final_domain.add(line)
                      count += 1
                  print(f'âœ… Loaded Text List: source_henry.list ({count} lines)')
          except Exception as e:
              print(f'âŒ Error loading henry list: {e}')

          # 3. ä¼˜åŒ–ï¼šå¦‚æœä¸€ä¸ªåŸŸåå·²ç»åœ¨ suffix é‡Œäº†ï¼Œå°±ä¸éœ€è¦åœ¨ domain é‡Œå†å­˜ä¸€é (è™½éå¿…é¡»ï¼Œä½†èƒ½å‡å°ä½“ç§¯)
          # è¿™æ˜¯ä¸€ä¸ªæ¿€è¿›çš„ä¼˜åŒ–ï¼Œå¦‚æœä½ å¸Œæœ›ä¿ç•™ç²¾ç¡®åŒ¹é…çš„ä¼˜å…ˆçº§ï¼Œå¯ä»¥æ³¨é‡Šæ‰ä¸‹é¢ä¸‰è¡Œ
          # list_suffixes = list(final_suffix)
          # final_domain = {d for d in final_domain if not any(d.endswith(s) for s in list_suffixes)}

          # 4. æ„å»ºæœ€ç»ˆ JSON (Version 2)
          output = {
              'version': 2,
              'rules': [
                  {
                      'domain': sorted(list(final_domain)),
                      'domain_suffix': sorted(list(final_suffix)),
                      'domain_keyword': sorted(list(final_keyword)),
                      'domain_regex': sorted(list(final_regex))
                  }
              ]
          }

          # ç§»é™¤ç©ºåˆ—è¡¨é”®å€¼å¯¹ï¼Œä¿æŒæ–‡ä»¶æ•´æ´
          # (Sing-box å…è®¸ç©ºåˆ—è¡¨ï¼Œä½†ç§»é™¤åæ–‡ä»¶æ›´å°)
          rules_obj = output['rules'][0]
          keys_to_remove = [k for k, v in rules_obj.items() if not v]
          for k in keys_to_remove:
              del rules_obj[k]

          with open('fakeip-filter.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          print('ğŸ‰ Merge Complete!')
          print(f'   Domains: {len(final_domain)}')
          print(f'   Suffixes: {len(final_suffix)}')
          print(f'   Keywords: {len(final_keyword)}')
          print(f'   Regex: {len(final_regex)}')
          "

          # ç¼–è¯‘
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs

      - name: Process WebRTC Rules (Remote JSON to Version 3 SRS)
        run: |
          curl -sL "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json" -o raw_webrtc.json
          
          python3 -c "
          import json
          try:
              with open('raw_webrtc.json', 'r') as f:
                  data = json.load(f)
              output = {
                  'version': 3,
                  'rules': data.get('rules', [])
              }
              with open('webRTC.json', 'w') as f:
                  json.dump(output, f, indent=2)
          except Exception as e:
              exit(1)
          "
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

      - name: Process Custom Rules
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          fi

      - name: Push to Repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ (ä¿ç•™ fakeip-filter.json å’Œ webRTC.json)
          rm -f raw_webrtc.json source_*.list source_*.json dustin.srs sing-box sing-box.tar.gz
          rm -rf sing-box-*
          
          # æ˜¾å¼æ·»åŠ 
          git add webRTC.json webRTC.srs
          git add fakeip-filter.srs fakeip-filter.json
          git add fakeip-filter-Remote-DNS.srs
          
          # æäº¤ (å¦‚æœæ— å˜æ›´åˆ™è·³è¿‡)
          git commit -m "ğŸš€ Sync Rules: $(date +'%Y-%m-%d %H:%M') | Optimized 3-Way Merge" || exit 0
          
          git push origin main --force
