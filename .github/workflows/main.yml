name: Update Comprehensive SRS

on:
  workflow_dispatch:
    inputs:
      manual_name:
        description: 'ä¸´æ—¶ä»»åŠ¡ï¼šæ–‡ä»¶å (ä¸å¸¦åŽç¼€)'
        required: false
      manual_url:
        description: 'ä¸´æ—¶ä»»åŠ¡ï¼šè§„åˆ™é“¾æŽ¥'
        required: false
  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹
  push:
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'fakeip-filter-Remote-DNS.json'
      - 'rules.json'

env:
  URL_ADBLOCK: "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json"
  URL_FAKEIP_S1: "https://raw.githubusercontent.com/77160860/rule/refs/heads/main/filter.json"
  URL_FAKEIP_S2_SRS: "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs"
  URL_FAKEIP_S3_LIST: "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list"
  URL_WEBRTC: "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ============================================================
      # 1. å¼ºåŠ›æ¸…ç† & åˆå§‹åŒ–
      # ============================================================
      - name: Clean Workspace & Init
        run: |
          echo "ðŸ§¹ Cleaning up workspace..."
          # åˆ é™¤æ—§çš„ rules æ–‡ä»¶å¤¹ (é˜²æ­¢æ®‹ç•™)
          rm -rf rules rules_json
          # åˆ›å»ºæ–°çš„ rules æ–‡ä»¶å¤¹
          mkdir -p rules
          
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªåˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ—§äº§ç‰©ï¼Œ
          # æ ¹ç›®å½•çš„ Git æ¸…ç†å°†åœ¨æœ€åŽçš„ Commit æ­¥éª¤ç»Ÿä¸€å¤„ç†

      # ============================================================
      # 2. å®‰è£…æ ¸å¿ƒ
      # ============================================================
      - name: Install Custom sing-box
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/singbox/sing-box-amd64"
          echo "â¬‡ï¸ Downloading core from: $DOWNLOAD_URL"
          curl -L --fail --retry 3 -A "Mozilla/5.0" "$DOWNLOAD_URL" -o sing-box
          chmod +x sing-box
          SB_VERSION=$(./sing-box version | awk '/version/{print $3}')
          echo "SB_VERSION=$SB_VERSION" >> $GITHUB_ENV

      # ============================================================
      # 3. è¿è¡Œå·¥åŽ‚è„šæœ¬ (äº§ç‰©è‡ªåŠ¨è¿›å…¥ rules/)
      # ============================================================
      - name: Run Rule Factory
        run: |
          if [[ -n "${{ inputs.manual_name }}" && -n "${{ inputs.manual_url }}" ]]; then
            echo "ðŸš€ æ¨¡å¼: æ‰‹åŠ¨è§¦å‘"
            python3 scripts/build_factory.py "${{ inputs.manual_name }}" "${{ inputs.manual_url }}"
          else
            echo "ðŸš€ æ¨¡å¼: æ‰¹é‡æž„å»º"
            python3 scripts/build_factory.py
          fi

      # ============================================================
      # 4. Task A (Adblock)
      # ============================================================
      - name: Task A - Build Adblock
        run: |
          echo "ðŸ›¡ï¸ Processing Adblock..."
          curl -sL --fail --retry 3 "$URL_ADBLOCK" -o Adblock.json
          ./sing-box rule-set compile Adblock.json -o Adblock.srs
          # ç§»åŠ¨åˆ° rules
          mv Adblock.srs rules/
          mv Adblock.json rules/

      # ============================================================
      # 5. Task B (FakeIP Consensus)
      # ============================================================
      - name: Task B - FakeIP Consensus
        run: |
          echo "ðŸ¤– Processing FakeIP..."
          curl -sL --fail --retry 3 "$URL_FAKEIP_S1" -o s1.json
          curl -sL --fail --retry 3 "$URL_FAKEIP_S2_SRS" -o s2.srs
          curl -sL --fail --retry 3 "$URL_FAKEIP_S3_LIST" -o s3.list
          
          ./sing-box rule-set decompile s2.srs -o s2.json
          python3 scripts/merge_fakeip.py
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs
          
          # ç§»åŠ¨åˆ° rules
          mv fakeip-filter.srs rules/
          mv fakeip-filter.json rules/

      # ============================================================
      # 6. Task C (Remote DNS)
      # ============================================================
      - name: Task C - Remote DNS
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            echo "ðŸŒ Processing Remote DNS..."
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
            # ç§»åŠ¨åˆ° rules
            mv fakeip-filter-Remote-DNS.srs rules/
            # æ³¨æ„ï¼šæºæ–‡ä»¶æ˜¯æ ¹ç›®å½•æ‰‹åŠ¨ç»´æŠ¤çš„ï¼Œå¤åˆ¶ä¸€ä»½åˆ° rules ä¾›å®¡è®¡ï¼Œä¿ç•™åŽŸæ–‡ä»¶
            cp fakeip-filter-Remote-DNS.json rules/
          fi

      # ============================================================
      # 7. Task D (WebRTC)
      # ============================================================
      - name: Task D - WebRTC
        run: |
          echo "ðŸ•¸ï¸ Processing WebRTC..."
          curl -sL --fail --retry 3 "$URL_WEBRTC" -o raw_webrtc.json
          
          python3 -c "
          import json
          try:
              with open('raw_webrtc.json') as f:
                  data = json.load(f)
              output = {'version': 3, 'rules': data.get('rules', [])}
              with open('webRTC.json', 'w') as f:
                  json.dump(output, f, indent=2)
          except Exception: exit(1)
          "
          
          ./sing-box rule-set compile webRTC.json -o webRTC.srs
          
          # ç§»åŠ¨åˆ° rules
          mv webRTC.srs rules/
          mv webRTC.json rules/

          # === æœ€ç»ˆåžƒåœ¾æ¸…ç† ===
          rm -f s1.json s2.json s2.srs s3.list raw_webrtc.json sing-box sing-box.tar.gz temp_*.json
          
          # === æäº¤ä»£ç  ===
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # -----------------------------------------------------------------
          # å…³é”®æ­¥éª¤ï¼šå¤„ç†æ ¹ç›®å½•çš„æ—§æ–‡ä»¶
          # -----------------------------------------------------------------
          # 1. æš‚å­˜æ‰€æœ‰ä¿®æ”¹
          git add .
          
          # 2. å‘Šè¯‰ gitï¼šæ ¹ç›®å½•ä¸åº”è¯¥æœ‰ .srs æ–‡ä»¶äº† (å¦‚æžœå­˜åœ¨ï¼Œåˆ™æ ‡è®°åˆ é™¤)
          # ä½¿ç”¨ ls é…åˆ git rmï¼Œé¿å…æ‰¾ä¸åˆ°æ–‡ä»¶æŠ¥é”™
          ls *.srs 2>/dev/null | xargs -r git rm --cached || true
          
          # 3. å‘Šè¯‰ gitï¼šæ ¹ç›®å½•ä¸åº”è¯¥æœ‰ç”Ÿæˆçš„ .json æ–‡ä»¶äº† 
          # (æŽ’é™¤ rules.json å’Œ fakeip-filter-Remote-DNS.json)
          ls *.json 2>/dev/null | grep -vE '^(rules\.json|fakeip-filter-Remote-DNS\.json)$' | xargs -r git rm --cached || true
          
          # 4. å¼ºåˆ¶æ·»åŠ  rules æ–‡ä»¶å¤¹
          git add rules/
          
          # 5. åˆ é™¤æ—§çš„ rules_json æ–‡ä»¶å¤¹è®°å½• (å¦‚æžœæœ‰)
          git rm -r --cached rules_json 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ðŸš€ Sync Rules (Cleaned) | Core: ${{ env.SB_VERSION }} | $(date +'%Y-%m-%d')"
            git push origin main
          fi
