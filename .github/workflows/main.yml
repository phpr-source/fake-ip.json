name: Update Comprehensive SRS

on:
  workflow_dispatch:
    inputs:
      manual_name:
        description: 'ä»»åŠ¡å'
        required: false
      manual_url:
        description: 'é“¾æ¥'
        required: false
  schedule:
    - cron: '0 20 * * *'
  push:
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'rule-providers.json'
      - '.github/workflows/**'

env:
  URL_ADBLOCK: "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json"
  URL_FAKEIP_S1: "https://raw.githubusercontent.com/77160860/rule/refs/heads/main/filter.json"
  URL_FAKEIP_S2_SRS: "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs"
  URL_FAKEIP_S3_LIST: "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list"
  URL_WEBRTC: "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ============================================================
      # 1. ç¯å¢ƒè‡ªæˆ‘ä¿®å¤ (è‡ªåŠ¨æ•‘ç¾)
      # ============================================================
      - name: Fix Environment
        run: |
          mkdir -p rules src
          
          # 1. å¦‚æœ fakeip æºæ–‡ä»¶è¿˜åœ¨æ ¹ç›®å½•ï¼Œå½’ä½åˆ° src
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            echo "ğŸ“¦ å½’æ¡£æºæ–‡ä»¶åˆ° src/"
            mv fakeip-filter-Remote-DNS.json src/
          fi
          
          # 2. å¦‚æœé…ç½®æ–‡ä»¶ä¸¢äº†ï¼Œè‡ªåŠ¨é‡å»ºï¼
          if [ ! -f "rule-providers.json" ]; then
            echo "âš ï¸ é…ç½®æ–‡ä»¶ä¸¢å¤±ï¼Œæ­£åœ¨é‡å»ºé»˜è®¤é…ç½®..."
            # è¿™é‡Œå¡«å…¥ä½ ä¹‹å‰çš„å†…å®¹
            echo '{"reject-list": "https://raw.githubusercontent.com/77160860/rule/main/reject.json"}' > rule-providers.json
          fi
          
          # æ¸…ç©º rules æ–‡ä»¶å¤¹ï¼Œç¡®ä¿ç”Ÿæˆçš„æ˜¯æœ€æ–°çš„
          rm -rf rules/*

      # ============================================================
      # 2. å®‰è£…æ ¸å¿ƒ
      # ============================================================
      - name: Install Core
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/singbox/sing-box-amd64"
          curl -L --fail --retry 3 -A "Mozilla/5.0" "$DOWNLOAD_URL" -o sing-box
          chmod +x sing-box
          echo "SB_VERSION=$(./sing-box version | awk '/version/{print $3}')" >> $GITHUB_ENV

      # ============================================================
      # 3. è¿è¡Œå·¥å‚ (å¤„ç† rule-providers.json)
      # ============================================================
      - name: Run Factory
        run: |
          if [[ -n "${{ inputs.manual_name }}" ]]; then
            python3 scripts/build_factory.py "${{ inputs.manual_name }}" "${{ inputs.manual_url }}"
          else
            python3 scripts/build_factory.py
          fi

      # ============================================================
      # 4. Task A: Adblock
      # ============================================================
      - name: Task A - Adblock
        run: |
          curl -sL --retry 3 "$URL_ADBLOCK" -o Adblock.json
          ./sing-box rule-set compile Adblock.json -o Adblock.srs
          mv Adblock.srs rules/
          mv Adblock.json rules/

      # ============================================================
      # 5. Task B: FakeIP
      # ============================================================
      - name: Task B - FakeIP
        run: |
          curl -sL --retry 3 "$URL_FAKEIP_S1" -o s1.json
          curl -sL --retry 3 "$URL_FAKEIP_S2_SRS" -o s2.srs
          curl -sL --retry 3 "$URL_FAKEIP_S3_LIST" -o s3.list
          
          ./sing-box rule-set decompile s2.srs -o s2.json
          python3 scripts/merge_fakeip.py
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs
          
          mv fakeip-filter.srs rules/
          mv fakeip-filter.json rules/

      # ============================================================
      # 6. Task C: Remote DNS (åŒæ—¶æ»¡è¶³å®‰å…¨å’Œå±•ç¤ºéœ€æ±‚)
      # ============================================================
      - name: Task C - Remote DNS
        run: |
          SRC="src/fakeip-filter-Remote-DNS.json"
          if [ -f "$SRC" ]; then
            # å¤åˆ¶ä¸€ä»½åˆ°å½“å‰ç›®å½•ç¼–è¯‘
            cp "$SRC" temp.json
            ./sing-box rule-set compile temp.json -o fakeip-filter-Remote-DNS.srs
            
            # 1. äº§ç‰©æ”¾å…¥ rules
            mv fakeip-filter-Remote-DNS.srs rules/
            # 2. ã€å…³é”®ã€‘æŠŠæºæ–‡ä»¶ä¹Ÿå¤åˆ¶ä¸€ä»½åˆ° rulesï¼Œæ»¡è¶³ä½ çš„â€œç»Ÿä¸€æŸ¥çœ‹â€éœ€æ±‚
            cp "$SRC" rules/fakeip-filter-Remote-DNS.json
            
            rm temp.json
          else
            echo "âš ï¸ Warning: $SRC not found"
          fi

      # ============================================================
      # 7. Task D: WebRTC
      # ============================================================
      - name: Task D - WebRTC
        run: |
          curl -sL --retry 3 "$URL_WEBRTC" -o raw.json
          python3 -c "import json; d=json.load(open('raw.json')); open('webRTC.json','w').write(json.dumps({'version':3,'rules':d.get('rules',[])},indent=2))"
          ./sing-box rule-set compile webRTC.json -o webRTC.srs
          mv webRTC.srs rules/
          mv webRTC.json rules/

      # ============================================================
      # 8. ç”Ÿæˆå…¨é‡ README
      # ============================================================
      - name: Generate Readme
        run: python3 scripts/build_factory.py --gen-readme

      # ============================================================
      # 9. æäº¤ (å®‰å…¨æ¸…ç†æ¨¡å¼)
      # ============================================================
      - name: Commit & Push
        run: |
          # 1. æ˜ç¡®æ¸…ç†è¿™äº›ä¸´æ—¶æ–‡ä»¶
          rm -f s1.json s2.json s2.srs s3.list raw.json sing-box sing-box.tar.gz temp_*.json
          
          # 2. æ¸…ç†æ ¹ç›®å½•æ®‹ç•™çš„äº§ç‰© (å¦‚æœæœ‰çš„è¯)
          rm -f *.srs
          
          # 3. é…ç½® Git
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # 4. æ™ºèƒ½æäº¤
          # -A å‚æ•°ä¼šè‡ªåŠ¨ï¼š
          # a. æŠŠ src/ é‡Œçš„å˜åŠ¨åŠ è¿›å»
          # b. æŠŠ rules/ é‡Œçš„å˜åŠ¨åŠ è¿›å»
          # c. æŠŠä¹‹å‰è¢«è¯¯åˆ çš„æ ¹ç›®å½• json æ–‡ä»¶ä» git è®°å½•ä¸­ç§»é™¤ (è®©ä»“åº“å˜å¹²å‡€)
          # d. è‡ªåŠ¨ä¿ç•™ rule-providers.json (å› ä¸ºå®ƒåœ¨ç£ç›˜ä¸Šæ˜¯å­˜åœ¨çš„)
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ğŸš€ Sync Rules | Core: ${{ env.SB_VERSION }} | $(date +'%Y-%m-%d')"
            git push origin main
          fi
