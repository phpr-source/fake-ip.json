name: Update Comprehensive SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - 'fakeip-filter-Remote-DNS.json'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Latest sing-box
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
          echo "Installing sing-box version $LATEST_VERSION"
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VERSION}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .

      - name: Combine Remote Rules
        run: |
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o henry.list
          grep -v '^#' henry.list | grep -v '^$' | sed 's/+/./g' > henry_domains.txt
          
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o dustin.srs
          ./sing-box rule-set decompile dustin.srs -o dustin.json

          python3 -c "
          import json
          with open('henry_domains.txt') as f:
              h_domains = [l.strip() for l in f if l.strip()]
          with open('dustin.json') as f:
              d_data = json.load(f)
          d_domains = []
          d_suffixes = []
          for rule in d_data.get('rules', []):
              d_domains.extend(rule.get('domain', []))
              d_suffixes.extend(rule.get('domain_suffix', []))
          all_domains = set(d_domains) | set([d for d in h_domains if not d.startswith('.')])
          all_suffixes = set(d_suffixes) | set([d[1:] if d.startswith('.') else d for d in h_domains if d.startswith('.')])
          combined = {
              'version': 1,
              'rules': [{'domain': sorted(list(all_domains)), 'domain_suffix': sorted(list(all_suffixes))}]
          }
          with open('combined.json', 'w') as f:
              json.dump(combined, f)
          "
          ./sing-box rule-set compile combined.json -o fakeip-filter.srs

      - name: Process Custom Rules
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          fi

      - name: Push to Repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          git rm -f custom.srs filter.srs custom_rules.json --ignore-unmatch
          
          git add .github/workflows/main.yml
          git add fakeip-filter-Remote-DNS.json
          git add fakeip-filter.srs
          git add fakeip-filter-Remote-DNS.srs
          
          # æäº¤ä¸¦å¼·åˆ¶æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼Œç¢ºä¿å€‰åº«ä¹¾æ·¨
          git commit -m "ğŸš€ Update to latest sing-box version & Cleanup workspace" || exit 0
          git push origin main --force
