name: Update Comprehensive SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - 'fakeip-filter-Remote-DNS.json'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Latest sing-box
        run: |
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
          echo "Installing sing-box version $LATEST_VERSION"
          curl -Lo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VERSION}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          mv sing-box-*/sing-box .

      - name: Combine Remote Rules (FakeIP)
        run: |
          # è·å– Henry è§„åˆ™
          curl -sL "https://raw.githubusercontent.com/HenryChiao/mihomo_yamls/refs/heads/main/custom/domain/fake-ip-filter.list" -o henry.list
          grep -v '^#' henry.list | grep -v '^$' | sed 's/+/./g' > henry_domains.txt
          
          # è·å– Dustin è§„åˆ™å¹¶åç¼–è¯‘
          curl -sL "https://github.com/DustinWin/ruleset_geodata/releases/download/sing-box-ruleset/fakeip-filter.srs" -o dustin.srs
          ./sing-box rule-set decompile dustin.srs -o dustin.json

          # åˆå¹¶è§„åˆ™å¹¶ç”Ÿæˆ fakeip-filter.json
          python3 -c "
          import json
          try:
              with open('henry_domains.txt') as f:
                  h_domains = [l.strip() for l in f if l.strip()]
              with open('dustin.json') as f:
                  d_data = json.load(f)
              
              d_domains = []
              d_suffixes = []
              for rule in d_data.get('rules', []):
                  d_domains.extend(rule.get('domain', []))
                  d_suffixes.extend(rule.get('domain_suffix', []))
              
              all_domains = set(d_domains) | set([d for d in h_domains if not d.startswith('.')])
              all_suffixes = set(d_suffixes) | set([d[1:] if d.startswith('.') else d for d in h_domains if d.startswith('.')])
              
              combined = {
                  'version': 1,
                  'rules': [{
                      'domain': sorted(list(all_domains)), 
                      'domain_suffix': sorted(list(all_suffixes))
                  }]
              }
              
              with open('fakeip-filter.json', 'w') as f:
                  json.dump(combined, f, indent=2, ensure_ascii=False)
              print('Successfully generated fakeip-filter.json')
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "
          # ç¼–è¯‘æˆ srs
          ./sing-box rule-set compile fakeip-filter.json -o fakeip-filter.srs

      - name: Process WebRTC Rules (Remote JSON to Version 3 SRS)
        run: |
          curl -sL "https://raw.githubusercontent.com/Kris-Channnn/sing-box-proxy/refs/heads/main/webRTC.json" -o raw_webrtc.json
          
          python3 -c "
          import json
          try:
              with open('raw_webrtc.json', 'r') as f:
                  data = json.load(f)
              output = {
                  'version': 3,
                  'rules': data.get('rules', [])
              }
              with open('webRTC.json', 'w') as f:
                  json.dump(output, f, indent=2, ensure_ascii=False)
              print('Successfully transformed webRTC.json to Version 3')
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "
          ./sing-box rule-set compile webRTC.json -o webRTC.srs

      - name: Process Custom Rules
        run: |
          if [ -f "fakeip-filter-Remote-DNS.json" ]; then
            ./sing-box rule-set compile fakeip-filter-Remote-DNS.json -o fakeip-filter-Remote-DNS.srs
          fi

      - name: Push to Repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # æ¸…é™¤ä¸å†éœ€è¦çš„æ—§æ–‡ä»¶
          git rm -f custom.srs filter.srs custom_rules.json --ignore-unmatch
          
          # åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶ä¸­é—´æ–‡ä»¶ï¼ˆä¿ç•™ç”Ÿæˆçš„ .json å’Œ .srsï¼‰
          rm -f raw_webrtc.json henry.list henry_domains.txt dustin.srs dustin.json sing-box sing-box.tar.gz
          
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          git add webRTC.json webRTC.srs
          git add fakeip-filter.json fakeip-filter.srs
          git add fakeip-filter-Remote-DNS.json fakeip-filter-Remote-DNS.srs
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸš€ Sync Rules: $(date +'%Y-%m-%d %H:%M') | WebRTC v3 & FakeIP JSON/SRS" || exit 0
          git push origin main --force
